name: CD - Push Docker Image to GHCR (Main Branch)

on:
  push:
    branches:
      - main # ðŸ›‘ DÃ©clenchement sur la branche 'main'

jobs:
  push_to_registry:
    name: Push Docker image to GitHub Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Permission essentielle pour publier sur le registre

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Login to GitHub Container Registry (GHCR)
        # Se connecte au registre Docker de GitHub en utilisant le jeton intÃ©grÃ©
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }} 
          password: ${{ secrets.GITHUB_TOKEN }} # Jeton temporaire fourni par GitHub Actions

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and Push Docker image
        # Construit et publie l'image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # DÃ©finit les tags pour l'image (format: ghcr.io/utilisateur/repo:tag)
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Success Message
        run: echo "CD SUCCESS: Image Docker publiÃ©e sur GHCR, prÃªte Ã  Ãªtre dÃ©ployÃ©e."