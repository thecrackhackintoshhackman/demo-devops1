name: CI Test with Docker (Run Branch)

on:
  push:
    branches:
      - run # üõë D√©clenchement sur la branche 'run'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v3

      - name: Build de l'image Docker
        run: docker build -t mon-site-ci .

      - name: Lancer le conteneur pour test
        # D√©marre l'image en arri√®re-plan et mappe le port 8080 de la VM au port 80 du conteneur
        run: docker run -d -p 8080:80 --name test-container mon-site-ci

      - name: Attendre que le service d√©marre
        run: sleep 5 # Laisse 5 secondes √† Nginx pour √™tre op√©rationnel

      - name: Test d'accessibilit√© (V√©rification CI)
        run: |
          # Envoie une requ√™te HTTP √† localhost:8080 et v√©rifie si le code de r√©ponse est 200 (OK)
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
          if [ "$response" -eq 200 ]; then
            echo "CI SUCCESS: Le site est accessible (HTTP 200)."
          else
            echo "CI FAILURE: Le site n'a pas r√©pondu ou a retourn√© $response."
            # Fait √©chouer le pipeline si le test √©choue
            exit 1
          fi

      - name: Nettoyage du conteneur
        # Arr√™te et supprime le conteneur de test
        run: docker rm -f test-container 

      - name: CI + Docker ex√©cut√© avec succ√®s !
        run: echo "Int√©gration et Tests Conteneuris√©s termin√©s sur la branche run."